<script>
  async function processLink() {
    const input = document.getElementById('shortLink').value.trim();
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '';

    if (!input) {
      resultDiv.innerHTML = '<span class="error">Vui lòng nhập link!</span>';
      return;
    }

    try {
      const urlObj = new URL(input);
      const base64Param = urlObj.searchParams.get('url');

      // CASE 1: Nếu có ?url=base64
      if (base64Param) {
        try {
          const decoded = decodeURIComponent(atob(base64Param));
          resultDiv.innerHTML = `<strong>Link gốc (Base64):</strong> <a href="${decoded}" target="_blank">${decoded}</a>`;
          return;
        } catch {
          resultDiv.innerHTML = '<span class="error">Giải mã base64 thất bại!</span>';
          return;
        }
      }

      // CASE 2: Thử HEAD redirect trực tiếp nếu không bị CORS
      try {
        const res = await fetch(input, { method: "HEAD", redirect: "follow" });
        const finalUrl = res.url;
        if (finalUrl && finalUrl !== input) {
          resultDiv.innerHTML = `<strong>Link gốc (HEAD redirect):</strong> <a href="${finalUrl}" target="_blank">${finalUrl}</a>`;
          return;
        }
      } catch (e) {
        // Nếu bị chặn CORS thì tiếp tục sang bước 3
      }

      // CASE 3: Gửi đến backend Render
      try {
        const response = await fetch('https://unshorten-backend.onrender.com/unshorten', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url: input })
        });

        const data = await response.json();

        if (response.ok && data.result) {
          resultDiv.innerHTML = `<strong>Link gốc (qua backend):</strong> <a href="${data.result}" target="_blank">${data.result}</a>`;
        } else if (data.originalUrl) {
          resultDiv.innerHTML = `<strong>Link gốc (qua backend):</strong> <a href="${data.originalUrl}" target="_blank">${data.originalUrl}</a>`;
        } else {
          resultDiv.innerHTML = `<span class="error">❌ Không thể giải mã link. Backend trả về lỗi.</span>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<span class="error">⚠️ Lỗi gọi backend: ${err.message}</span>`;
      }

    } catch (err) {
      resultDiv.innerHTML = '<span class="error">❌ Link không hợp lệ!</span>';
    }
  }
</script>
